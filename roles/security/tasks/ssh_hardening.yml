---
- name: Install openssh-server if not installed
  ansible.builtin.apt:
    name: openssh-server 
    state: present

- name: Ensure openssh-server is running
  ansible.builtin.service:
    name: ssh
    state: started
    enabled: true

- name: Install SSH hardening drop-in
  ansible.builtin.template:
    src: templates/sshd_config.j2
    dest: /etc/ssh/sshd_config.d/99-hardening.conf
    owner: root
    group: root
    mode: 0644
    validate: /usr/sbin/sshd -t -f %s
  notify: restart-ssh

- name: Apply SSH changes immediately
  meta: flush_handlers

- name: Switch Ansible to new SSH port
  set_fact:
    ansible_port: "{{ new_port }}"

- name: Get listening TCP/UDP sockets
  ansible.builtin.command: ss -tulnp
  register: ss_output
  changed_when: false

- name: Filter ss lines
  ansible.builtin.set_fact:
    sshd_lines: "{{ ss_output.stdout_lines | select('search', 'sshd') | list }}"

- name: Assert sshd is listening on port {{ new_port }}
  ansible.builtin.assert:
    that: 
      - (sshd_lines | select('search', ':' ~ new_port ~ '\\b') | list | length) > 0
    fail_msg: "sshd is NOT listening on {{ new_port }} Lines found: {{ sshd_lines }}"
    success_msg: "sshd is listening on {{ new_port }}"